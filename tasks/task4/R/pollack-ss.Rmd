---
title: "Pollack" 
subtitle: " Operating Model"
author: "Laurence Kell"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown:::html_document
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEncoding{UTF-8}
tags: FLPKG FLR
license: Creative Commons Attribution-ShareAlike 4.0 International
---
  

```{r knitr_init, echo=FALSE, results="hide"}
library(knitr)
## Global options
opts_chunk$set(echo    =FALSE,
               eval    =TRUE,
               cache   =!FALSE,
               cache.path="../cache/om/",
               prompt  =FALSE,
               comment =NA,
               message =FALSE,
               tidy    =FALSE,
               warning =FALSE,
               fig.height=6,
               fig.width =8,
               fig.path  ="../tex/om-")

iFig=0
```
```{r, pkgs, echo=FALSE, message=FALSE}
library(plyr)
library(dplyr)
library(ggplot2)
library(reshape2)

library(GGally)
library(corrplot)

library(ggplotFL)
library(FLBRP)
library(diags)
library(r4ss)
library(ss3om)

library(gam)

options(digits=3)
```
```{r, dirs, echo=FALSE, message=FALSE}
dirMy=dirname(dirname(FLife:::getScriptPath()))
#dirMy="/home/laurence/Desktop/sea++/mydas/tasks/task4"
dirInp="/home/laurence/Desktop/rfmo/ices/cs/2017/pollack/SS3"
dirDat=file.path(dirMy,"data")
```
```{r, source}
source('~/Desktop/flr/diags/R/ss-SRR.R')
```

```{r, data-ss}
ss=list("base" =SS_output(file.path(dirInp,"base"),  verbose=FALSE,printstats=FALSE))
```

```{r, data-stk}
om=FLStocks("base" =readFLSss3(file.path(dirInp,"base")))

save(om,file=file.path(dirDat,"om.RData"))
```


\newpage
# Figures
```{r, flstock, fig.height=9}
ggplot(plot(om[[1]])$data)+
  geom_line(aes(year,data,col=unit))+
  facet_grid(qname~.,scale="free")+
  xlab("Year")+ylab("")+
  guides(col=guide_legend(title="Sex"))+
  theme_bw()
```
**Figure `r iFig=iFig+1; iFig`** Time series of recruitment, SSB, catch and fishing mortality.


```{r, srr, fig.height=6,fig.width=8}
theme_set(theme_bw())

srr=FLSRs(llply(ss,function(x) {
           res=ssSRR(x)
           #units(rec(res))="1000s"
           #units(ssb(res))="Tonnes"
           res}))

plot(srr)
```
**Figure `r iFig=iFig+1; iFig`** Stock recruitment relationship as fitted by SS.  


```{r ccf, fig.height=6,fig.width=8}
with(subset(model.frame(FLQuants(srr[[1]],Recruits=rec,SSB=ssb)),year>1980),ccf(rank(SSB),rank(Recruits)))
```
**Figure `r iFig=iFig+1; iFig`** Cross Spearman correlations between SSB and recruitmemt, a positive lag indicates that a stock-recruit relationship and a negative lag a recruit-stock relationship.

```{r, srr2, fig.height=10}
theme_set(theme_bw())

srr=FLSRs(llply(srr,fmle,control=list(silent=TRUE)))

plot(srr[[1]])
```
**Figure `r iFig=iFig+1; iFig`** Fit to stock recruitment relationship, with goodness of fit diagnostics. 


```{r, alk, eval=FALSE}
alk=ldply(ss,function(x) subset(melt(x$ALK),value!=0))

names(alk)=c("scenario","length","age","morph","data")
alk=transform(alk,
              season=ifelse(morph%in%c("Seas: 1 Sub_Seas: 1 Morph: 1",
                                       "Seas: 1 Sub_Seas: 1 Morph: 2"),1,2),
              sex   =ifelse(morph%in%c("Seas: 1 Sub_Seas: 1 Morph: 1",
                                       "Seas: 1 Sub_Seas: 2 Morph: 1"),1,2))

dat=transform(subset(alk,season==1&scenario=="base"),sex=c("F","M")[sex])
ggplot(dat)+
   geom_histogram(aes(length,weight=data),binwidth=2)+
   facet_grid(sex~age,scale="free_x")+
   geom_vline(aes(xintercept=V1,col=sex),
               data=ddply(dat,.(age,sex), with,  
            sum(data*length)/sum(data)),size=1)+
   scale_y_continuous(breaks=NULL)+
   coord_flip()+
   xlab("Length")+ylab("Proportion")+
   theme_bw()
#**Figure `r iFig=iFig+1; iFig`** Length distributions by age from the age length key generated by SS3.
```

```{r, eval=FALSE}
library(FLasher)

om1=fwd(om[[1]],catch=catch(om[[1]][,-1]))
```


```{r}
theme_set(theme_bw())

omay=FLStocks(llply(om,simplify))
sr  =fmle(as.FLSR(omay[[1]],model="bevholt"),control=list(silent=TRUE))

eql=FLBRP(omay[[1]],sr=sr)

plot(eql)
```
**Figure `r iFig=iFig+1; iFig`** Equilibrium curves with reference points.


\newpage
## Software
All analysis was conducted using R and FLR and the `diags` package which provides a set of common methods for reading these data into R, plotting and summarising them.(http://www.flr-project.org/)

* `r version$version.string`
* FLCore: `r packageVersion('FLCore')`
* diags: `r # packageVersion('diags')`
* ggplotFL: `r # packageVersion('ggplotFL')`
* diags: `r # packageVersion('diags')`
* r4ss: `r # packageVersion('r4ss')`

* **Compiled**: `r date()`

## Author information

**Laurence Kell**. laurie@seaplusplus.es

## Acknowledgements

This vignette and many of the methods documented in it were developed under the MyDas project funded by the Irish exchequer and EMFF 2014-2020. The overall aim of MyDas is to develop and test a range of assessment models and methods to establish Maximum Sustainable Yield (MSY) reference points (or proxy MSY reference points) across the spectrum of data-limited stocks.

# References {#References}